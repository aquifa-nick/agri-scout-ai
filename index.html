<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Scout AI - Weed Identifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        
        :root {
            /* Color System */
            --color-bg-primary: #0F0F0F;
            --color-bg-surface: rgba(30, 30, 30, 0.8);
            --color-bg-surface-solid: #1E1E1E;
            --color-accent-primary: #FF8C42;
            --color-accent-secondary: #4ECDC4;
            --color-text-primary: #FFFFFF;
            --color-text-secondary: #A0A0A0;
            --color-border: #333333;
            --color-border-subtle: rgba(255, 255, 255, 0.1);
            --color-input-bg: rgba(255, 255, 255, 0.05);
            --color-error: #FF6B6B;
            
            /* Typography Scale */
            --text-xl: 28px;
            --text-lg: 22px;
            --text-md: 18px;
            --text-base: 16px;
            --text-sm: 14px;
            
            /* Spacing System (8px base) */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --space-5: 40px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-pill: 50px;
            
            /* Shadows */
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-elevated: 0 12px 48px rgba(0, 0, 0, 0.4);
            
            /* Transitions */
            --transition-fast: 200ms ease-out;
            --transition-medium: 300ms ease-in-out;
        }
        
        body {
            background: linear-gradient(180deg, #02423c 0%, var(--color-bg-primary) 100%);
            color: var(--color-text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 120px; /* Space for bottom navigation */
            margin: 0;
        }
        
        /* Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--text-base);
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            min-height: 44px;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-pill);
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: var(--color-accent-primary);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-card);
        }
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--color-accent-primary);
            border: 2px solid var(--color-accent-primary);
        }
        .btn-secondary:hover:not(:disabled) {
            background: var(--color-accent-primary);
            color: var(--color-text-primary);
            transform: translateY(-1px);
        }
        
        /* Card System */
        .card {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-3) 0;
            box-shadow: var(--shadow-card);
            backdrop-filter: blur(8px);
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
        }
        
        .info-icon {
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .info-content {
            flex: 1;
        }
        
        /* Typography */
        .text-xl { font-size: var(--text-xl); font-weight: 700; color: var(--color-text-primary); }
        .text-lg { font-size: var(--text-lg); font-weight: 600; color: var(--color-text-primary); }
        .text-md { font-size: var(--text-md); font-weight: 400; color: var(--color-text-primary); }
        .text-base { font-size: var(--text-base); font-weight: 400; color: var(--color-text-primary); }
        .text-sm { font-size: var(--text-sm); font-weight: 500; color: var(--color-text-secondary); }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        
        /* Layout */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 var(--space-2);
        }
        
        .section {
            margin: var(--space-4) 0;
        }
        
        .section-header {
            margin-bottom: var(--space-4);
        }
        
        /* Header */
        .app-header {
            background: var(--color-bg-surface);
            border-bottom: 1px solid var(--color-border-subtle);
            backdrop-filter: blur(8px);
            position: relative;
            z-index: 100;
            /* Mobile: half screen height */
            height: 50vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Desktop: reduce header height */
        @media (min-width: 768px) {
            .app-header {
                height: 30vh;
                min-height: 200px;
            }
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        
        .app-logo {
            max-width: 280px;
            width: 70%;
            height: auto;
            filter: brightness(1) contrast(1);
        }
        
        /* Hide on mobile if too small */
        @media (max-width: 480px) {
            .app-logo {
                max-width: 240px;
                width: 80%;
            }
        }
        
        /* Media Preview */
        .media-preview {
            border: 2px solid var(--color-accent-primary);
            border-radius: var(--radius-md);
            padding: var(--space-1);
            background: var(--color-bg-surface-solid);
        }
        
        /* Screen Management */
        .screen {
            display: block;
        }
        
        .screen.hidden {
            display: none;
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Results Styling */
        .result-card {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin: var(--space-3) 0;
            box-shadow: var(--shadow-card);
        }
        
        .confidence-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-pill);
            font-size: var(--text-sm);
            font-weight: 600;
            margin: var(--space-1) 0;
        }
        
        .confidence-high { background: rgba(76, 205, 196, 0.2); color: var(--color-accent-secondary); }
        .confidence-medium { background: rgba(255, 140, 66, 0.2); color: var(--color-accent-primary); }
        .confidence-low { background: rgba(255, 107, 107, 0.2); color: var(--color-error); }
        
        .recommendation-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin: var(--space-2) 0;
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            margin: var(--space-2) 0;
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .recommendation-icon {
            width: 24px;
            height: 24px;
            background: var(--color-accent-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            flex-shrink: 0;
        }
        
        /* History Styling */
        .history-item {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin: var(--space-2) 0;
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }
        
        .history-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border-subtle);
        }
        
        .history-content {
            flex: 1;
        }
        
        .history-date {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            margin-top: var(--space-1);
        }
        
        /* Navigation */
        .nav-btn {
            transition: all var(--transition-fast);
        }
        
        .nav-btn.active {
            color: var(--color-accent-primary) !important;
        }
        
        .nav-btn:hover {
            opacity: 0.8;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-surface);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-accent-primary);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 140, 66, 0.8);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <img src="logo.svg" alt="Weed AI" class="app-logo">
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="section" style="position: relative; min-height: 40vh; margin-top: var(--space-2);">
        
            <!-- Camera Screen -->
            <div id="camera-screen" class="screen">
                <div class="card">
                    <div class="section-header" style="text-align: center;">
                        <div style="width: 56px; height: 56px; background: var(--color-accent-primary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-2);">
                            <span style="font-size: 24px;">üì∑</span>
                        </div>
                        <h2 class="text-lg text-primary">Identify Weed</h2>
                        <p class="text-base text-secondary">Take a clear photo to identify the weed</p>
                    </div>

                    <!-- Photo Tips -->
                    <div class="info-card" style="margin: var(--space-3) 0;">
                        <div class="info-icon">üí°</div>
                        <div class="info-content">
                            <p class="text-sm text-secondary"><strong>Photo Tips:</strong></p>
                            <ul class="text-sm text-secondary" style="margin-left: var(--space-2); margin-top: var(--space-1);">
                                <li>‚Ä¢ Get close to the weed</li>
                                <li>‚Ä¢ Ensure good lighting</li>
                                <li>‚Ä¢ Include leaves and stem</li>
                                <li>‚Ä¢ Hold camera steady</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Camera Options -->
                    <div style="display: flex; flex-direction: column; gap: var(--space-2); margin: var(--space-4) 0;">
                        <button id="take-photo-btn" class="btn btn-primary">
                            <span style="margin-right: var(--space-1);">üì∑</span>
                            Take Photo
                        </button>
                        <button id="upload-photo-btn" class="btn btn-secondary">
                            <span style="margin-right: var(--space-1);">üìÅ</span>
                            Upload from Gallery
                        </button>
                    </div>

                    <!-- Hidden file inputs -->
                    <input type="file" id="camera-input" accept="image/*" capture="camera" style="display: none;">
                    <input type="file" id="upload-input" accept="image/*" style="display: none;">

                    <!-- Photo Preview -->
                    <div id="photo-preview" class="media-preview hidden" style="margin: var(--space-4) 0;">
                        <img id="preview-image" alt="Captured photo" style="width: 100%; height: auto; border-radius: var(--radius-md);">
                        <div style="display: flex; gap: var(--space-2); margin-top: var(--space-2);">
                            <button id="retake-photo-btn" class="btn btn-secondary">
                                <span style="margin-right: var(--space-1);">üîÑ</span>
                                Retake
                            </button>
                            <button id="analyze-photo-btn" class="btn btn-primary">
                                <span style="margin-right: var(--space-1);">üîç</span>
                                Analyze Photo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen hidden">
                <div class="card" style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <div class="loading-pulse" style="margin: var(--space-4) 0;">
                        <h2 class="text-lg text-primary">Analyzing Your Photo...</h2>
                        <p class="text-base text-secondary" style="margin-top: var(--space-2);">Our AI is examining the weed in your image</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: var(--space-1); margin-top: var(--space-4);">
                        <p class="text-sm text-secondary">üîç Processing image...</p>
                        <p class="text-sm text-secondary">üß† Running AI analysis...</p>
                        <p class="text-sm text-secondary">üìä Generating recommendations...</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Screen -->
            <div id="results-screen" class="screen hidden">
                <div id="results-container">
                    <!-- Results will be populated here by JavaScript -->
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; flex-direction: column; gap: var(--space-2); margin-top: var(--space-4);">
                    <button id="new-identification-btn" class="btn btn-primary">
                        <span style="margin-right: var(--space-1);">üì∑</span>
                        Identify Another Weed
                    </button>
                    <button id="view-history-btn" class="btn btn-secondary">
                        <span style="margin-right: var(--space-1);">üìö</span>
                        View History
                    </button>
                </div>
            </div>

            <!-- History Screen -->
            <div id="history-screen" class="screen hidden">
                <div class="card">
                    <div class="section-header" style="text-align: center;">
                        <div style="width: 56px; height: 56px; background: var(--color-accent-secondary); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-2);">
                            <span style="font-size: 24px;">üìö</span>
                        </div>
                        <h2 class="text-lg text-primary">Identification History</h2>
                        <p class="text-base text-secondary">Your past weed identifications</p>
                    </div>
                    
                    <div id="history-container" style="margin: var(--space-4) 0;">
                        <!-- History items will be populated here -->
                    </div>
                    
                    <button id="back-to-camera-btn" class="btn btn-secondary" style="margin-top: var(--space-4);">
                        <span style="margin-right: var(--space-1);">‚Üê</span>
                        Back to Camera
                    </button>
                </div>
            </div>

            <!-- Error Screen -->
            <div id="error-screen" class="screen hidden">
                <div class="card" style="text-align: center;">
                    <div style="width: 56px; height: 56px; background: var(--color-error); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-3);">
                        <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    </div>
                    <h2 class="text-lg text-primary">Analysis Failed</h2>
                    
                    <div class="info-card" style="margin: var(--space-4) 0;">
                        <div class="info-icon">‚ùå</div>
                        <div class="info-content">
                            <p id="error-message" class="text-base text-secondary">Something went wrong during analysis. Please try again.</p>
                        </div>
                    </div>
                    
                    <button id="retry-btn" class="btn btn-primary" style="margin-top: var(--space-4);">
                        <span style="margin-right: var(--space-1);">üîÑ</span>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav style="position: fixed; bottom: var(--space-2); left: var(--space-2); right: var(--space-2); background: var(--color-bg-surface); backdrop-filter: blur(8px); border: 1px solid var(--color-border-subtle); border-radius: var(--radius-xl); padding: var(--space-2); display: flex; justify-content: space-around; z-index: 1000;">
        <button id="nav-camera" class="nav-btn active" style="display: flex; flex-direction: column; align-items: center; padding: var(--space-1); background: none; border: none; color: var(--color-accent-primary); cursor: pointer;">
            <span style="font-size: 20px; margin-bottom: 4px;">üì∑</span>
            <span style="font-size: 12px; font-weight: 500;">Camera</span>
        </button>
        <button id="nav-history" class="nav-btn" style="display: flex; flex-direction: column; align-items: center; padding: var(--space-1); background: none; border: none; color: var(--color-text-secondary); cursor: pointer;">
            <span style="font-size: 20px; margin-bottom: 4px;">üìö</span>
            <span style="font-size: 12px; font-weight: 500;">History</span>
        </button>
    </nav>

    <!-- Footer -->
    <footer style="text-align: center; padding: var(--space-4) var(--space-2); margin-top: var(--space-5);">
        <div class="container">
            <div style="width: 40px; height: 40px; background: var(--color-bg-surface); border: 1px solid var(--color-border-subtle); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-2);">
                <span style="font-size: 18px;">üåæ</span>
            </div>
            <p class="text-base text-primary" style="font-weight: 600;">¬© 2024 Agri-Scout AI</p>
            <p class="text-sm text-secondary">Simple weed identification</p>
        </div>
    </footer>

    <script>
        // Global variables
        let capturedPhoto = null;
        let identificationHistory = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            setupEventListeners();
            showScreen('camera-screen');
        });

        function setupEventListeners() {
            // Camera buttons
            document.getElementById('take-photo-btn').addEventListener('click', () => document.getElementById('camera-input').click());
            document.getElementById('upload-photo-btn').addEventListener('click', () => document.getElementById('upload-input').click());
            
            // File inputs
            document.getElementById('camera-input').addEventListener('change', handlePhotoCapture);
            document.getElementById('upload-input').addEventListener('change', handlePhotoCapture);
            
            // Photo preview buttons
            document.getElementById('retake-photo-btn').addEventListener('click', retakePhoto);
            document.getElementById('analyze-photo-btn').addEventListener('click', analyzePhoto);
            
            // Results buttons
            document.getElementById('new-identification-btn').addEventListener('click', startNewIdentification);
            document.getElementById('view-history-btn').addEventListener('click', () => showScreen('history-screen'));
            
            // History navigation
            document.getElementById('back-to-camera-btn').addEventListener('click', () => showScreen('camera-screen'));
            
            // Bottom navigation
            document.getElementById('nav-camera').addEventListener('click', () => {
                showScreen('camera-screen');
                updateNavigation('camera');
            });
            document.getElementById('nav-history').addEventListener('click', () => {
                showScreen('history-screen');
                updateNavigation('history');
            });
            
            // Error screen
            document.getElementById('retry-btn').addEventListener('click', () => showScreen('camera-screen'));
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Show target screen
            document.getElementById(screenId).classList.remove('hidden');
            
            // Update navigation if needed
            if (screenId === 'camera-screen') {
                updateNavigation('camera');
            } else if (screenId === 'history-screen') {
                updateNavigation('history');
            }
        }

        function updateNavigation(activeTab) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${activeTab}`).classList.add('active');
        }

        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    capturedPhoto = e.target.result;
                    document.getElementById('preview-image').src = capturedPhoto;
                    document.getElementById('photo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function retakePhoto() {
            capturedPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('camera-input').value = '';
            document.getElementById('upload-input').value = '';
        }

        async function analyzePhoto() {
            if (!capturedPhoto) {
                showError('No photo captured');
                return;
            }

            showScreen('loading-screen');
            
            try {
                const response = await callBackendAnalysis(capturedPhoto, {
                    cropType: 'unknown',
                    growthStage: 'unknown',
                    recentApplications: ''
                });
                
                // Save to history
                const historyItem = {
                    id: Date.now(),
                    photo: capturedPhoto,
                    result: response,
                    timestamp: new Date().toISOString()
                };
                
                identificationHistory.unshift(historyItem);
                saveHistory();
                
                displayResults(response);
                showScreen('results-screen');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Failed to analyze photo. Please check your connection and try again.');
            }
        }

        async function callBackendAnalysis(imageData, context) {
            // Check backend health first
            try {
                const healthResponse = await fetch('/api/health');
                if (!healthResponse.ok) {
                    throw new Error('Backend not available');
                }
            } catch (error) {
                console.error('Backend health check failed:', error);
                throw new Error('Cannot connect to analysis service');
            }

            // Send the full data URL (including data:image/jpeg;base64, prefix)
            const requestData = {
                imageData: imageData,
                context: `Analyze this weed image. Crop: ${context.cropType}, Growth stage: ${context.growthStage}, Recent applications: ${context.recentApplications || 'None specified'}`
            };

            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`Analysis failed: ${response.status} - ${errorData}`);
            }

            return await response.json();
        }

        function displayResults(analysisData) {
            const container = document.getElementById('results-container');
            
            // Extract the result from the API response
            const result = analysisData.result || analysisData;
            
            if (!result || !result.identification) {
                container.innerHTML = `
                    <div class="result-card">
                        <h3 class="text-lg text-primary">Analysis Unavailable</h3>
                        <p class="text-base text-secondary">Unable to analyze the image. Please try again.</p>
                    </div>
                `;
                return;
            }

            const { identification, description, invasiveness, management } = result;
            const confidence = identification.confidence || 0;
            
            let confidenceClass = 'confidence-low';
            if (confidence >= 80) confidenceClass = 'confidence-high';
            else if (confidence >= 60) confidenceClass = 'confidence-medium';

            // Determine invasiveness color
            let invasivenessClass = 'confidence-low';
            if (invasiveness?.level) {
                switch(invasiveness.level.toLowerCase()) {
                    case 'low': invasivenessClass = 'confidence-high'; break;
                    case 'moderate': invasivenessClass = 'confidence-medium'; break;
                    case 'high': invasivenessClass = 'confidence-low'; break;
                    case 'severe': invasivenessClass = 'confidence-low'; break;
                    default: invasivenessClass = 'confidence-medium';
                }
            }

            container.innerHTML = `
                <div class="result-card">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
                        <div>
                            <h3 class="text-lg text-primary">${identification.commonName}</h3>
                            <p class="text-sm text-secondary" style="font-style: italic;">${identification.scientificName}</p>
                        </div>
                        <div class="confidence-badge ${confidenceClass}">
                            ${confidence}% Confidence
                        </div>
                    </div>
                    
                    ${description ? `
                        <div class="info-card" style="margin: var(--space-3) 0;">
                            <div class="info-icon">üìù</div>
                            <div class="info-content">
                                <p class="text-base text-primary">${description}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${invasiveness ? `
                        <div class="info-card" style="margin: var(--space-3) 0;">
                            <div class="info-icon">‚ö†Ô∏è</div>
                            <div class="info-content">
                                <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                                    <h4 class="text-base text-primary" style="margin: 0;">Invasiveness Level</h4>
                                    <div class="confidence-badge ${invasivenessClass}" style="font-size: 12px;">
                                        ${invasiveness.level}
                                    </div>
                                </div>
                                <p class="text-sm text-secondary">${invasiveness.description}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${management && management.organic && management.organic.length > 0 ? `
                        <div style="margin: var(--space-4) 0;">
                            <h4 class="text-md text-primary" style="margin-bottom: var(--space-2);">üå± Organic Management Options</h4>
                            <div class="recommendation-list">
                                ${management.organic.map((item, index) => `
                                    <div class="recommendation-item">
                                        <div class="recommendation-icon" style="background: var(--color-accent-secondary);">${index + 1}</div>
                                        <div style="flex: 1;">
                                            <p class="text-base" style="color: #333;">${item}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${management && management.chemical && management.chemical.length > 0 ? `
                        <div style="margin: var(--space-4) 0;">
                            <h4 class="text-md text-primary" style="margin-bottom: var(--space-2);">üß™ Chemical Management Options</h4>
                            <div class="recommendation-list">
                                ${management.chemical.map((item, index) => `
                                    <div class="recommendation-item">
                                        <div class="recommendation-icon">üß™</div>
                                        <div style="flex: 1;">
                                            <p class="text-base" style="color: #333;">${item}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function loadHistory() {
            const saved = localStorage.getItem('agri-scout-history');
            if (saved) {
                identificationHistory = JSON.parse(saved);
            }
            updateHistoryDisplay();
        }

        function saveHistory() {
            // Keep only last 50 items
            if (identificationHistory.length > 50) {
                identificationHistory = identificationHistory.slice(0, 50);
            }
            localStorage.setItem('agri-scout-history', JSON.stringify(identificationHistory));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const container = document.getElementById('history-container');
            
            if (identificationHistory.length === 0) {
                container.innerHTML = `
                    <div class="info-card">
                        <div class="info-icon">üì≠</div>
                        <div class="info-content">
                            <p class="text-base text-secondary">No identifications yet. Take your first weed photo!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = identificationHistory.map(item => {
                const date = new Date(item.timestamp).toLocaleDateString();
                const time = new Date(item.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const confidence = item.result?.identification?.confidence || 0;
                
                return `
                    <div class="history-item" onclick="viewHistoryItem('${item.id}')">
                        <img src="${item.photo}" alt="Weed photo" class="history-thumbnail">
                        <div class="history-content">
                            <h4 class="text-base text-primary">${item.result?.identification?.commonName || 'Unknown'}</h4>
                            <p class="text-sm text-secondary">${confidence}% confidence</p>
                            <p class="history-date">${date} at ${time}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewHistoryItem(itemId) {
            const item = identificationHistory.find(h => h.id == itemId);
            if (item) {
                displayResults(item.result);
                showScreen('results-screen');
            }
        }

        function startNewIdentification() {
            capturedPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('camera-input').value = '';
            document.getElementById('upload-input').value = '';
            showScreen('camera-screen');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            showScreen('error-screen');
        }

        // Health check function
        async function checkBackendHealth() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend status:', data);
                    return data;
                } else {
                    console.warn('Backend health check failed:', response.status);
                    return null;
                }
            } catch (error) {
                console.warn('Cannot connect to backend:', error.message);
                return null;
            }
        }

        // Check backend on load
        checkBackendHealth();
    </script>
</body>
</html>